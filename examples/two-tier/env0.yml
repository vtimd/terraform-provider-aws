#Avner Version
version: 1
deploy:
  steps:
    setupVariables:
      after:
        - curl -L -o opa https://openpolicyagent.org/downloads/latest/opa_linux_amd64
        - chmod 755 ./opa
        - ./opa version
        - curl --location https://github.com/accurics/terrascan/releases/download/v1.4.0/terrascan_1.4.0_Darwin_x86_64.tar.gz --output terrascan.tar.gz
        - tar -xvf terrascan.tar.gz
        - install terrascan /usr/local/bin
        - terrascan
    terraformPlan:
      after:
        - terraform show -json .tf-plan > tf-plan.json
        - ./opa eval --fail-defined "data.terraform.validation.violations[msg]" --input tf-plan.json --data ./tf-lib.rego --data ./validation.rego --format values 1>&2

